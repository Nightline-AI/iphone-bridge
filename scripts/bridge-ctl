#!/bin/bash
# iPhone Bridge Control Script
# Manage your iPhone Bridge installation

set -e

INSTALL_DIR="${IPHONE_BRIDGE_DIR:-$HOME/iphone-bridge}"
LOG_DIR="/var/log/iphone-bridge"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

# Load client ID from env
if [[ -f "$INSTALL_DIR/.env" ]]; then
    source "$INSTALL_DIR/.env" 2>/dev/null || true
fi

cmd_help() {
    echo -e "${CYAN}iPhone Bridge Control${NC}"
    echo ""
    echo "Usage: bridge-ctl <command>"
    echo ""
    echo "Commands:"
    echo "  status        Show bridge and management status"
    echo "  start         Start all services"
    echo "  stop          Stop all services"
    echo "  restart       Restart all services"
    echo "  logs [name]   Tail logs (bridge, management, tunnel-bridge, tunnel-manage, updater)"
    echo "  config        Edit configuration"
    echo "  update        Update to latest version"
    echo "  uninstall     Remove the bridge"
    echo "  urls          Show public URLs"
    echo ""
}

cmd_status() {
    echo -e "${CYAN}iPhone Bridge Status${NC}"
    echo ""
    
    # Services to check
    declare -A SERVICES
    SERVICES[bridge]="com.nightline.iphone-bridge"
    SERVICES[management]="com.nightline.management-agent"
    SERVICES[updater]="com.nightline.iphone-bridge-updater"
    
    if [[ -n "$NIGHTLINE_CLIENT_ID" ]]; then
        SERVICES[tunnel-bridge]="com.nightline.cloudflare-tunnel-bridge-${NIGHTLINE_CLIENT_ID}"
        SERVICES[tunnel-manage]="com.nightline.cloudflare-tunnel-manage-${NIGHTLINE_CLIENT_ID}"
    fi
    
    # Check each service
    for name in bridge management tunnel-bridge tunnel-manage updater; do
        label="${SERVICES[$name]}"
        if [[ -z "$label" ]]; then
            continue
        fi
        
        if launchctl list 2>/dev/null | grep -q "$label"; then
            echo -e "  ${GREEN}●${NC} $name"
        else
            echo -e "  ${RED}○${NC} $name"
        fi
    done
    
    echo ""
    
    # Try bridge health endpoint
    HEALTH=$(curl -s http://localhost:8080/health 2>/dev/null || echo '{"status":"unreachable"}')
    STATUS=$(echo "$HEALTH" | python3 -c "import json,sys; print(json.load(sys.stdin).get('status','error'))" 2>/dev/null || echo "error")
    
    case "$STATUS" in
        healthy)
            echo -e "Bridge Health: ${GREEN}Healthy${NC}"
            ;;
        degraded)
            echo -e "Bridge Health: ${YELLOW}Degraded${NC}"
            ;;
        *)
            echo -e "Bridge Health: ${RED}$STATUS${NC}"
            ;;
    esac
    
    # Try management health
    MGMT_HEALTH=$(curl -s http://localhost:8081/health 2>/dev/null || echo '{"status":"unreachable"}')
    MGMT_STATUS=$(echo "$MGMT_HEALTH" | python3 -c "import json,sys; print(json.load(sys.stdin).get('status','error'))" 2>/dev/null || echo "error")
    echo -e "Management:    ${MGMT_STATUS}"
    
    echo ""
    cmd_urls
}

cmd_urls() {
    if [[ -n "$NIGHTLINE_CLIENT_ID" ]]; then
        echo -e "${CYAN}URLs:${NC}"
        echo -e "  Bridge:     ${GREEN}https://bridge-${NIGHTLINE_CLIENT_ID}.nightline.app${NC}"
        echo -e "  Management: ${GREEN}https://manage-${NIGHTLINE_CLIENT_ID}.nightline.app${NC}"
    else
        echo -e "${YELLOW}Client ID not configured${NC}"
    fi
}

cmd_start() {
    echo -e "${YELLOW}Starting services...${NC}"
    
    launchctl load "$HOME/Library/LaunchAgents/com.nightline.iphone-bridge.plist" 2>/dev/null || true
    launchctl load "$HOME/Library/LaunchAgents/com.nightline.management-agent.plist" 2>/dev/null || true
    
    if [[ -n "$NIGHTLINE_CLIENT_ID" ]]; then
        launchctl load "$HOME/Library/LaunchAgents/com.nightline.cloudflare-tunnel-bridge-${NIGHTLINE_CLIENT_ID}.plist" 2>/dev/null || true
        launchctl load "$HOME/Library/LaunchAgents/com.nightline.cloudflare-tunnel-manage-${NIGHTLINE_CLIENT_ID}.plist" 2>/dev/null || true
    fi
    
    launchctl load "$HOME/Library/LaunchAgents/com.nightline.iphone-bridge-updater.plist" 2>/dev/null || true
    
    sleep 2
    cmd_status
}

cmd_stop() {
    echo -e "${YELLOW}Stopping services...${NC}"
    
    launchctl unload "$HOME/Library/LaunchAgents/com.nightline.iphone-bridge.plist" 2>/dev/null || true
    launchctl unload "$HOME/Library/LaunchAgents/com.nightline.management-agent.plist" 2>/dev/null || true
    
    if [[ -n "$NIGHTLINE_CLIENT_ID" ]]; then
        launchctl unload "$HOME/Library/LaunchAgents/com.nightline.cloudflare-tunnel-bridge-${NIGHTLINE_CLIENT_ID}.plist" 2>/dev/null || true
        launchctl unload "$HOME/Library/LaunchAgents/com.nightline.cloudflare-tunnel-manage-${NIGHTLINE_CLIENT_ID}.plist" 2>/dev/null || true
    fi
    
    launchctl unload "$HOME/Library/LaunchAgents/com.nightline.iphone-bridge-updater.plist" 2>/dev/null || true
    
    echo -e "${GREEN}Stopped${NC}"
}

cmd_restart() {
    echo -e "${YELLOW}Restarting services...${NC}"
    
    launchctl kickstart -k "gui/$(id -u)/com.nightline.iphone-bridge" 2>/dev/null || true
    launchctl kickstart -k "gui/$(id -u)/com.nightline.management-agent" 2>/dev/null || true
    
    if [[ -n "$NIGHTLINE_CLIENT_ID" ]]; then
        launchctl kickstart -k "gui/$(id -u)/com.nightline.cloudflare-tunnel-bridge-${NIGHTLINE_CLIENT_ID}" 2>/dev/null || true
        launchctl kickstart -k "gui/$(id -u)/com.nightline.cloudflare-tunnel-manage-${NIGHTLINE_CLIENT_ID}" 2>/dev/null || true
    fi
    
    sleep 2
    cmd_status
}

cmd_logs() {
    LOG_NAME="${1:-bridge}"
    
    case "$LOG_NAME" in
        bridge)
            LOG_FILE="$LOG_DIR/bridge.log"
            ;;
        management|manage|mgmt)
            LOG_FILE="$LOG_DIR/management.log"
            ;;
        tunnel-bridge|tunnel)
            LOG_FILE="$LOG_DIR/tunnel-bridge.log"
            ;;
        tunnel-manage)
            LOG_FILE="$LOG_DIR/tunnel-manage.log"
            ;;
        updater|update)
            LOG_FILE="$LOG_DIR/updater.log"
            ;;
        *)
            echo -e "${RED}Unknown log: $LOG_NAME${NC}"
            echo "Available: bridge, management, tunnel-bridge, tunnel-manage, updater"
            exit 1
            ;;
    esac
    
    echo -e "${CYAN}Tailing $LOG_FILE (Ctrl+C to exit)${NC}"
    echo ""
    tail -f "$LOG_FILE"
}

cmd_config() {
    if [[ -n "$EDITOR" ]]; then
        $EDITOR "$INSTALL_DIR/.env"
    elif command -v nano &>/dev/null; then
        nano "$INSTALL_DIR/.env"
    else
        vim "$INSTALL_DIR/.env"
    fi
    
    echo -e "${YELLOW}Config updated. Restart to apply changes:${NC}"
    echo "  bridge-ctl restart"
}

cmd_update() {
    echo -e "${YELLOW}Updating iPhone Bridge...${NC}"
    
    cd "$INSTALL_DIR"
    git pull origin main 2>/dev/null || git pull origin master
    
    source "$INSTALL_DIR/.venv/bin/activate"
    pip install -q fastapi "uvicorn[standard]" pydantic pydantic-settings httpx watchdog
    
    echo -e "${GREEN}Updated!${NC}"
    echo ""
    echo "Restart to apply: bridge-ctl restart"
}

cmd_uninstall() {
    echo -e "${RED}This will completely remove iPhone Bridge.${NC}"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Uninstalling...${NC}"
        
        cmd_stop
        
        # Remove launchd plists
        rm -f "$HOME/Library/LaunchAgents/com.nightline.iphone-bridge.plist"
        rm -f "$HOME/Library/LaunchAgents/com.nightline.management-agent.plist"
        rm -f "$HOME/Library/LaunchAgents/com.nightline.iphone-bridge-updater.plist"
        rm -f "$HOME/Library/LaunchAgents/com.nightline.cloudflare-tunnel-"*.plist
        
        # Backup config
        if [[ -f "$INSTALL_DIR/.env" ]]; then
            cp "$INSTALL_DIR/.env" "$HOME/.iphone-bridge-env.backup"
            echo -e "${DIM}Config backed up to ~/.iphone-bridge-env.backup${NC}"
        fi
        
        rm -rf "$INSTALL_DIR"
        
        echo -e "${GREEN}Uninstalled.${NC}"
    else
        echo "Cancelled."
    fi
}

# Main
case "${1:-help}" in
    status)     cmd_status ;;
    start)      cmd_start ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    logs)       cmd_logs "$2" ;;
    config)     cmd_config ;;
    update)     cmd_update ;;
    uninstall)  cmd_uninstall ;;
    urls)       cmd_urls ;;
    help|--help|-h) cmd_help ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        cmd_help
        exit 1
        ;;
esac
